<html xmlns:th="http://www.thymeleaf.org">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center">Chat Room</h1>
    <input type="hidden" id="accountId" th:value="${roomId}">
    <div id="chat"
         class="d-flex flex-column justify-content-end border p-2"
         style="height: 400px; overflow-y: scroll">
    </div>
    <div class="input-group mt-4">
        <!-- hiển thị senderName, backend render ra (ẩn input nếu muốn) -->
        <input id="senderInput" type="text" class="form-control" placeholder="Nhập tên..." th:value="${name}">
    </div>
    <div class="input-group mt-4">
        <input id="messageInput" type="text" class="form-control" placeholder="Nhập tin nhắn...">
        <button id="send" class="btn btn-primary">Gửi</button>
    </div>
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    let stompClient = null;

    let roomId = document.getElementById('accountId').value; // Lấy từ hidden input
    console.log('DEBUG roomId:', roomId); // Kiểm tra giá trị
    let senderName = document.getElementById('senderInput').value;

    function setConnected(connected) {
        document.getElementById('send').disabled = !connected;
    }

    function connect() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected to room: ' + roomId); // ✅ Log roomId
            setConnected(true);
            stompClient.subscribe('/topic/chat/' + roomId, function (message) {
                console.log('Received: ', message); // ✅ Log incoming message
                showMessages(JSON.parse(message.body));
            });
        });
    }

    function showMessages(message) {
        const chat = document.getElementById('chat');
        const messageElement = document.createElement('div');
        messageElement.textContent = message.sender + ': ' + message.content;
        messageElement.className = "border-bottom mb-1";
        chat.appendChild(messageElement);
        chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
        const content = document.getElementById('messageInput').value;
        if (!senderName || !content) return;
        const chatMessage = {
            sender: senderName,
            content: content
        };
        stompClient.send('/app/chat/' + roomId, {}, JSON.stringify(chatMessage));
        document.getElementById('messageInput').value = '';
    }

    window.onload = function () {
        connect();
        document.getElementById('send').onclick = sendMessage;
        // cho phép nhấn Enter để gửi
        document.getElementById('messageInput').addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    };
</script>
</html>
