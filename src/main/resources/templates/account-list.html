<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω t√†i kho·∫£n</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<style>
    body {
        margin: 0;
        font-family: 'Nunito', sans-serif;
        background-color: white;
        color: #333;
    }

    .dashboard {
        display: flex;
        height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        width: 230px;
        min-width: 230px;
        max-width: 230px;
        background-color: #2ec4b6;
        color: white;
        height: 94.5vh;
        top: 0;
        left: 0;
        padding: 20px;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar-title {
        font-size: 22px;
        margin-bottom: 30px;
        text-align: center;
    }

    .sidebar-menu {
        list-style: none;
        padding: 0;
    }

    .sidebar-menu li {
        margin-bottom: 20px;
    }

    .sidebar-menu a {
        color: white;
        text-decoration: none;
        font-size: 16px;
        display: block;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background 0.3s;
    }

    .sidebar-menu li.active a,
    .sidebar-menu a:hover {
        background-color: #28b1a5;
    }

    /* Main content */
    .main-content {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
    }

    .page-title {
        font-size: 28px;
        margin-bottom: 25px;
    }

    /* Table */
    .table-container {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        background-color: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
    }

    .account-table {
        width: 100%;
        border-collapse: collapse;
    }

    .account-table th,
    .account-table td {
        text-align: left;
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
    }

    .account-table th {
        background-color: #e0f7f5;
        color: #333;
    }

    tr:hover {
        background-color: #f9f9f9;
    }

    /* Buttons */
    .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background 0.3s;
    }

    /* Add Category Button */
    .add-account-btn {
        padding: 8px 14px;
        background-color: #00b894;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }

    .add-account-btn:hover {
        background-color: #009e82;
    }

    /* Pagination */
    .pagination {
        text-align: center;
        margin-top: 20px;
    }

    .pagination ul {
        display: inline-flex;
        list-style: none;
        padding: 0;
        gap: 5px;
    }

    .pagination ul li a {
        padding: 8px 12px;
        text-decoration: none;
        background-color: #e0f7f5;
        color: #333;
        border-radius: 6px;
        transition: background 0.2s;
        font-weight: bold;
    }

    .pagination ul li a:hover {
        background-color: #2ec4b6;
        color: white;
    }

    .pagination ul li.active a {
        background-color: #2ec4b6;
        color: white;
    }

    .action-dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 6px;
        transition: background-color 0.2s;
    }

    .dropdown-toggle:hover {
        background-color: #f0f0f0;
    }

    .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background-color: #fff;
        min-width: 140px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        z-index: 100;
        border-radius: 8px;
        padding: 4px 0;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        width: 100%;
        font-size: 14px;
        color: #333;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .ban-btn {
        background-color: #fff5f5;
        color: #c62828;
    }

    .ban-btn:hover {
        background-color: #ffecec;
    }

    .unban-btn {
        color: #2e7d32;
    }

    .unban-btn:hover {
        background-color: #d9f5df;
    }

    .action-dropdown:hover .dropdown-menu {
        display: block;
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-box {
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 30px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        box-sizing: border-box;
    }

    .modal-box h2 {
        margin-top: 0;
        margin-bottom: 20px;
    }

    .modal-box input, .modal-box select {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-actions .btn.submit {
        background-color: #27ae60;
        color: white;
    }

    .modal-actions .btn.cancel {
        background-color: #e74c3c;
        color: white;
    }

    .admin-info {
        margin: 27pc 0 10px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background-color: #f7f7f7;
        border-radius: 8px;
    }

    .admin-details {
        gap: 3px;
        display: flex;
        flex-direction: column;
    }

    .admin-name {
        color: #1f2937;
        font-weight: bold;
        font-size: 14px;
    }

    .admin-role {
        font-size: 12px;
        color: #777;
    }

    .home-btn {
        color: #28a745;
        font-size: 18px;
        text-decoration: none;
    }

    .home-btn:hover {
        color: #1e7e34;
    }

    .logout-btn {
        color: #dc3545;
        font-size: 18px;
        text-decoration: none;
    }

    .logout-btn:hover {
        color: #c82333;
    }
</style>
<body>

<div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2 class="sidebar-title">Admin Dashboard</h2>

        <ul class="sidebar-menu">
            <li><a href="/admin/dashboard">üìä Th·ªëng k√™</a></li>
            <li class="active"><a href="/admin/account">üë• T√†i kho·∫£n ng∆∞·ªùi d√πng</a></li>
        </ul>

        <!-- Th√¥ng tin ng∆∞·ªùi d√πng -->
        <div class="admin-info">
            <div class="admin-details">
                <span class="admin-name" th:text="${session.loggedInUser.getName()}">Name</span>
                <span class="admin-role" th:text="${session.loggedInUser.getRole()}">Role</span>
            </div>
            <div class="admin-details">
                <a href="/home" class="home-btn" title="Home">
                    <i class="fas fa-home"></i>
                </a>
                <a href="/logout" class="logout-btn" title="ƒêƒÉng xu·∫•t">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <main class="main-content">
        <h1 class="page-title">Qu·∫£n l√Ω t√†i kho·∫£n</h1>
        <button class="btn add-account-btn"
                onclick="openCreateModal()">
            T·∫°o t√†i kho·∫£n m·ªõi
        </button>

        <!-- Table -->
        <div class="table-container">
            <table class="account-table">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>T√™n</th>
                    <th>SƒêT</th>
                    <th>Vai tr√≤</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Thao t√°c</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="a : ${accounts}">
                    <td th:text="${a.accountId}"></td>
                    <td th:text="${a.name}"></td>
                    <td th:text="${a.phone}"></td>
                    <td th:text="${a.role.value}"></td>
                    <td th:id="'status-' + ${a.accountId}" th:text="${a.status.value}"></td>
                    <td>
                        <div class="action-dropdown">
                            <button type="button" class="dropdown-toggle">‚ãÆ</button>
                            <div class="dropdown-menu">
                                <button th:onclick="'viewDetail(' + ${a.accountId} + ')'"
                                        class="dropdown-item">Chi ti·∫øt</button>

                                <button type="button"
                                        th:data-id="${a.accountId}"
                                        th:data-status="${a.status.value}"
                                        th:text="${a.status.value == 'HoaÃ£t ƒëoÃ£ÃÇng' ? 'Kh√≥a' : 'M·ªü kh√≥a'}"
                                        th:class="'dropdown-item ' + (${a.status.value == 'HoaÃ£t ƒëoÃ£ÃÇng' ? 'ban-btn' : 'unban-btn'})"
                                        onclick="changeStatus(this)">
                                </button>

                            </div>
                        </div>
                    </td>

                </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination">
                <ul>
                    <li th:if="${currentPage > 0}">
                        <a th:href="@{'/admin/account'(page=${currentPage - 1}, size=${size})}">¬´</a>
                    </li>
                    <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:class="${i == currentPage} ? 'active'">
                        <a th:href="@{'/admin/account'(page=${i}, size=${size})}"
                        th:text="${i + 1}"></a>
                    </li>
                    <li th:if="${currentPage < totalPages - 1}">
                        <a th:href="@{'/admin/account'(page=${currentPage + 1}, size=${size})}">¬ª</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Popup Modal -->
        <div class="modal-overlay" id="createAccountModal">
            <div class="modal-box">
                <h2>T·∫°o t√†i kho·∫£n m·ªõi</h2>

                <div th:if="${error}" style="color: red; margin-bottom: 10px;">
                    <p th:text="${error}"></p>
                </div>

                <form th:action="@{/admin/create}" method="post" id="createAccountForm">
                    <label>T√™n:</label>
                    <input type="text" name="name" id="createName" required><br><br>

                    <label>SƒêT:</label>
                    <input type="text" name="phone" id="createPhone" required><br><br>

                    <label>M·∫≠t kh·∫©u:</label>
                    <input type="password" name="password" id="createPassword" required><br><br>

                    <label>Vai tr√≤:</label>
                    <select id="createRole" name="role">
                        <option th:each="r : ${roles}"
                                th:value="${r.name()}"
                                th:text="${r.value}">
                        </option>
                    </select>
                    <br>

                    <div class="modal-actions">
                        <button type="submit" class="btn submit">T·∫°o</button>
                        <button type="button" class="btn cancel" onclick="closeCreateModal()">H·ªßy</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Chi ti·∫øt t√†i kho·∫£n -->
        <div id="accountDetailModal" class="modal-overlay">
            <div class="modal-box">
                <h2>Chi ti·∫øt t√†i kho·∫£n</h2>
                <form id="accountDetailForm">
                    <input type="hidden" id="accountId">

                    <label for="name">T√™n:</label>
                    <input type="text" id="name" required><br><br>

                    <label for="phone">SƒêT:</label>
                    <input type="text" id="phone" required><br><br>

                    <div class="form-group" id="passwordGroup" style="display:none;">
                        <label for="password">M·∫≠t kh·∫©u:</label>
                        <input type="password" id="password" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (n·∫øu ƒë·ªïi)">
                    </div>

                    <label for="role">Vai tr√≤:</label>
                    <select id="role" name="role">
                        <option th:each="r : ${roles}"
                                th:value="${r.name()}"
                                th:text="${r.value}">
                        </option>
                    </select>
                    <br><br>

                    <label for="status">Tr·∫°ng th√°i:</label>
                    <select id="status" name="status">
                        <option th:each="s : ${statuses}"
                                th:value="${s.name()}"
                                th:text="${s.value}">
                        </option>
                    </select>
                    <br><br>

                    <div class="modal-actions">
                        <button type="button" class="btn submit" id="updateBtn" onclick="submitUpdate()">C·∫≠p nh·∫≠t</button>
                        <button type="button" class="btn cancel" onclick="closeDetailModal()">ƒê√≥ng</button>
                    </div>
                </form>
            </div>
        </div>

    </main>
</div>
</body>
<script>
function openCreateModal() {
document.getElementById('createAccountModal').style.display = 'flex';

// ·∫®n role ADMIN v√† CUSTOMER
const roleSelect = document.querySelector('#createAccountModal select[name="role"]');
        Array.from(roleSelect.options).forEach(option => {
            if (option.value.toUpperCase() === "ADMIN" || option.value.toUpperCase() === "CUSTOMER") {
                option.style.display = "none";
            } else {
                option.style.display = "block";
            }
        });
    }

    function closeCreateModal() {
        document.getElementById('createAccountModal').style.display = 'none';
    }

document.getElementById("createAccountForm").addEventListener("submit", async function(e) {
    e.preventDefault(); // ngƒÉn submit m·∫∑c ƒë·ªãnh

    const name = document.getElementById("createName").value.trim();
    const phone = document.getElementById("createPhone").value.trim();
    const password = document.getElementById("createPassword").value;
    const phoneRegex = /^0\d{9}$/;

    if (name.length < 2 || name.length > 50) {
        alert("T√™n ph·∫£i t·ª´ 2 ƒë·∫øn 50 k√Ω t·ª±");
        return;
    }
    if (!phoneRegex.test(phone)) {
        alert("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (b·∫Øt ƒë·∫ßu b·∫±ng 0, ƒë·ªß 10 s·ªë)");
        return;
    }
    if (password.length < 6) {
        alert("M·∫≠t kh·∫©u ph·∫£i √≠t nh·∫•t 6 k√Ω t·ª±");
        return;
    }

    // Ki·ªÉm tra tr√πng phone b·∫±ng AJAX
    const response = await fetch(`/admin/check-phone?phone=${encodeURIComponent(phone)}`);
    const data = await response.json();
    if (data.exists) {
        alert("S·ªë ƒëi·ªán tho·∫°i ƒë√£ c√≥ t√†i kho·∫£n!");
        return;
    }

    // N·∫øu t·∫•t c·∫£ ok ‚Üí submit form
    this.submit();
});



function viewDetail(id) {
        fetch('/admin/detail/' + id)
            .then(res => {
                if (!res.ok) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n.");
                }
                return res.json();
            })
            .then(data => {
                // Populate c√°c field
                document.getElementById("accountId").value = data.accountId;
                document.getElementById("name").value = data.name;
                document.getElementById("phone").value = data.phone;
                document.getElementById("role").value = data.role;
                document.getElementById("status").value = data.status;

                // ·∫®n b·ªõt role Admin v√† Customer khi update
                const roleSelect = document.getElementById("role");
                Array.from(roleSelect.options).forEach(option => {
                    if (option.value.toUpperCase() === "ADMIN" || option.value.toUpperCase() === "CUSTOMER") {
                        option.style.display = "none";
                    } else {
                        option.style.display = "block";
                    }
                });

                // Hi·ªÉn th·ªã ho·∫∑c ·∫©n √¥ nh·∫≠p m·∫≠t kh·∫©u
                if (data.role.toUpperCase() !== "ADMIN" && data.role.toUpperCase() !== "CUSTOMER") {
                    document.getElementById("passwordGroup").style.display = "block";
                } else {
                    document.getElementById("passwordGroup").style.display = "none";
                }

                // Reset disabled state
                const nameField = document.getElementById("name");
                const phoneField = document.getElementById("phone");
                const roleField = document.getElementById("role");
                const statusField = document.getElementById("status");
                const updateBtn = document.getElementById("updateBtn");

                nameField.readOnly = false;
                phoneField.readOnly = false;
                roleField.disabled = false;
                statusField.disabled = false;
                updateBtn.style.display = 'inline-block';

                const role = data.role.toUpperCase();

                if (role === "ADMIN") {
                    // Admin ‚Üí kh√¥ng cho ch·ªânh g√¨
                    nameField.readOnly = true;
                    phoneField.readOnly = true;
                    roleField.disabled = true;
                    statusField.disabled = true;
                    updateBtn.style.display = 'none';
                } else if (role === "CUSTOMER") {
                    // Customer ‚Üí cho ch·ªânh nh∆∞ng kh√¥ng cho ƒë·ªïi role
                    phoneField.disabled = true;
                    roleField.disabled = true;
                }

                // Show modal
                document.getElementById("accountDetailModal").style.display = 'flex';
            })
            .catch(err => {
                alert(err.message);
            });
    }


    function closeDetailModal() {
        document.getElementById("accountDetailModal").style.display = 'none';
    }

    function submitUpdate() {
        const id = document.getElementById("accountId").value;
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const role = document.getElementById("role").value;
        const status = document.getElementById("status").value;
        const password = document.getElementById("password").value.trim();
        const phoneRegex = /^0\d{9}$/;

        // Validate t√™n
        if (name.length < 2 || name.length > 50) {
            alert("T√™n ph·∫£i t·ª´ 2 ƒë·∫øn 50 k√Ω t·ª±");
            return;
        }

        // Validate s·ªë ƒëi·ªán tho·∫°i
        if (!phoneRegex.test(phone)) {
            alert("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (b·∫Øt ƒë·∫ßu b·∫±ng 0, ƒë·ªß 10 s·ªë)");
            return;
        }

        // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i l√™n
        const data = { name, phone, role, status };

        // Ch·ªâ g·ª≠i password n·∫øu c√≥ nh·∫≠p v√† role kh√¥ng ph·∫£i ADMIN/CUSTOMER
        if (password && role !== "ADMIN" && role !== "CUSTOMER") {
            data.password = password;
        }

        fetch('/admin/update/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(msg => { throw new Error(msg); });
                }
                alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                closeDetailModal();
                location.reload();
            })
            .catch(err => {
                alert(err.message);
            });
    }

    function changeStatus(button) {
        const id = button.getAttribute("data-id");

        fetch('/admin/change-status/' + id, {
            method: 'POST'
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Thay ƒë·ªïi tr·∫°ng th√°i th·∫•t b·∫°i.");
                }
                return res.text();
            })
            .then(message => {
                alert(message);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi
                const statusCell = document.getElementById("status-" + id);
                const currentStatus = button.getAttribute("data-status");

                let newStatus, newText, newClass;
                if (currentStatus === "HoaÃ£t ƒëoÃ£ÃÇng") {
                    newStatus = "Kh√≥a";
                    newText = "M·ªü kh√≥a";
                    newClass = "unban-btn";
                } else {
                    newStatus = "HoaÃ£t ƒëoÃ£ÃÇng";
                    newText = "Kh√≥a";
                    newClass = "ban-btn";
                }

                statusCell.innerText = newStatus;
                button.innerText = newText;
                button.setAttribute("data-status", newStatus);
                button.className = "dropdown-item " + newClass;
            })
            .catch(err => {
                alert(err.message);
            });
    }

</script>
</html>
