<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Doctor dashboard</title>
    <style>
        body {
            margin: 0;
            font-family: "Nunito", sans-serif;
            background-color: #f9fbfc;
        }

        .dashboard {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 230px;
            min-width: 230px;
            max-width: 230px;
            background-color: #2ec4b6;
            color: white;
            height: 94.5vh;
            top: 0;
            left: 0;
            padding: 20px;
            transition: width 0.3s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar-title {
            font-size: 22px;
            margin-bottom: 30px;
            text-align: center;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-menu li {
            margin-bottom: 20px;
        }

        .sidebar-menu a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            display: block;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .sidebar-menu li.active a,
        .sidebar-menu a:hover {
            background-color: #28b1a5;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .table-container {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background-color: white;
            border-radius: 12px;
            overflow: visible;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
            z-index: 1;
            overflow: visible;
            position: relative;
        }

        .product-table th,
        .product-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .product-table th {
            background-color: #e0f7f5;
            color: #333;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* ƒê·∫£m b·∫£o t·∫•t c·∫£ c√°c element trong table kh√¥ng ƒë√® l√™n dropdown */
        .product-table th,
        .product-table td {
            position: relative;
            z-index: 1;
        }

        /* ƒê·∫£m b·∫£o dropdown kh√¥ng b·ªã che b·ªüi c√°c h√†ng kh√°c */
        .product-table tr {
            position: relative;
            z-index: 1;
        }

        /* TƒÉng z-index cho h√†ng c√≥ dropdown ƒëang m·ªü */
        .product-table tr:hover {
            z-index: 1000;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            padding: 20px;
        }

        .modal-box {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh; /* üëà gi·ªõi h·∫°n chi·ªÅu cao */
            overflow-y: auto; /* üëà th√™m scroll khi n·ªôi dung d√†i */
            padding: 30px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            box-sizing: border-box;
            position: relative;
            z-index: 1000000;
        }

        .modal-box label {
            font-weight: 600;
            margin-top: 10px;
            display: block;
        }

        .modal-box input,
        .modal-box select,
        .modal-box textarea {
            width: 100%;
            padding: 10px;
            margin: 6px 0 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .modal-box textarea {
            resize: vertical;
        }

        .form-group-full {
            width: 100%;
        }

        .image-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .image-input-group input {
            flex: 1;
        }

        .upload-btn {
            padding: 8px;
            background-color: #2ec4b6;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .upload-btn svg {
            width: 20px;
            height: 20px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #2ec4b6;
            color: white;
        }

        .btn-secondary {
            background-color: #ccc;
            color: black;
        }

        .btn-primary:hover {
            background-color: #26b2a5;
        }

        .btn-secondary:hover {
            background-color: #aaa;
        }

        @media (max-width: 640px) {
            .modal-box {
                max-width: 90%;
                padding: 20px;
            }

            .modal-box input,
            .modal-box select,
            .modal-box textarea {
                font-size: 14px;
            }
        }

        .pagination {
            margin-top: 20px;
            text-align: center;
        }

        .pagination ul {
            list-style: none;
            display: inline-flex;
            padding: 0;
            gap: 6px;
        }

        .pagination ul li a {
            padding: 8px 14px;
            background-color: #e0f7f5;
            color: #333;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
        }

        .pagination ul li a:hover {
            background-color: #2ec4b6;
            color: white;
        }

        .pagination ul li.active a {
            background-color: #2ec4b6;
            color: white;
        }

        /* Dropdown container */
        .action-dropdown {
            position: relative;
            display: inline-block;
            z-index: 10000;
        }

        /* Button 3 ch·∫•m */
        .dots-toggle {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background-color 0.2s;
            color: #333;
        }

        .dots-toggle:hover {
            background-color: #f0f0f0;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            padding: 8px 0;
            z-index: 100001;
            border: 1px solid #e0e0e0;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateY(-5px);
            pointer-events: none;
        }

        /* Ensure dropdown shows below by default */
        .action-dropdown:hover .dropdown-menu,
        .dropdown-menu:hover {
            display: block;
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .action-dropdown .dropdown-menu {
            pointer-events: auto;
            margin-top: 0; /* Lo·∫°i b·ªè kho·∫£ng c√°ch */
        }

        /* T·∫°o ph·∫ßn "c·∫ßu n·ªëi" gi·ªØa n√∫t v√† menu ƒë·ªÉ tr√°nh kho·∫£ng tr·ªëng */
        .action-dropdown .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: transparent;
        }

        /* Ensure dropdown shows to the left when near right edge */
        .action-dropdown.right-edge .dropdown-menu {
            right: auto;
            left: 0;
        }

        /* Responsive dropdown positioning */
        @media (max-width: 768px) {
            .dropdown-menu {
                right: auto;
                left: 0;
                min-width: 140px;
            }
        }

        /* Ensure dropdown is always visible */
        .dropdown-menu {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Auto-adjust dropdown position based on available space */
        .action-dropdown:hover .dropdown-menu {
            display: block !important;
            animation: fadeIn 0.2s ease-in-out;
        }

        /* Animation for dropdown appearance */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Th√™m transition ƒë·ªÉ dropdown m∆∞·ª£t m√† h∆°n */
        .dropdown-menu {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* Ensure dropdown is always on top */
        .action-dropdown {
            position: relative;
        }

        .action-dropdown .dropdown-menu {
            position: absolute;
            z-index: 100001;
            pointer-events: auto;
            /* ƒê·∫£m b·∫£o dropdown kh√¥ng b·ªã c·∫Øt */
            clip: auto;
            overflow: visible;
        }

        /* ƒê·∫£m b·∫£o dropdown menu c√≥ th·ªÉ hover ƒë·ªÉ gi·ªØ m·ªü */
        .action-dropdown .dropdown-menu:hover {
            display: block !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* Th√™m CSS ƒë·ªÉ tr√°nh kho·∫£ng tr·ªëng gi·ªØa n√∫t v√† menu */
        .action-dropdown .dots-toggle {
            position: relative;
            z-index: 100001;
        }

        .action-dropdown .dropdown-menu {
            margin-top: 0;
            padding-top: 8px;
        }

        /* ƒê·∫£m b·∫£o dropdown lu√¥n hi·ªÉn th·ªã tr√™n c√πng */
        .action-dropdown {
            z-index: 100000;
        }

        .action-dropdown .dropdown-menu {
            z-index: 100001;
        }

        /* TƒÉng z-index cho to√†n b·ªô b·∫£ng khi c√≥ dropdown m·ªü */
        .table-container {
            position: relative;
            z-index: 1;
        }

        /* B·ªè hi·ªáu ·ª©ng hover cho table container */
        /* .table-container:hover {
            z-index: 99999;
        } */

        /* Ensure action column has enough space */
        .product-table td:last-child {
            min-width: 60px;
            width: auto;
            white-space: nowrap;
            overflow: visible;
            position: relative;
            z-index: 100002;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            width: 100%;
            font-size: 14px;
            color: #333;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
            box-sizing: border-box;
            position: relative;
            z-index: 100002;
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        /* ƒê·∫£m b·∫£o dropdown item kh√¥ng b·ªã che khu·∫•t */
        .dropdown-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .dropdown-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .dropdown-item.delete-btn {
            color: #dc3545;
            font-weight: 500;
        }

        .dropdown-item.delete-btn:hover {
            background-color: #ffe5e5;
        }

        /* Toast th√¥ng b√°o*/
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000001;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: fadeInOut 3s ease forwards;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        @keyframes fadeInOut {
            0%   { opacity: 0; transform: translateY(-20px); }
            10%  { opacity: 1; transform: translateY(0); }
            90%  { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .toast.hidden {
            display: none;
        }

        .toast.show {
            display: block;
        }

        /* Search form styles */
        .search-pet {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-right: 10px;
            font-size: 14px;
        }

        .search-btn {
            padding: 8px 16px;
            background-color: #2ec4b6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-btn:hover {
            background-color: #26b2a5;
        }

        /* Button styles */
        .detail-btn, .prescription-btn, .approved-btn, .disapproved-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            text-decoration: none;
            display: inline-block;
        }

        .detail-btn {
            background-color: #17a2b8;
            color: white;
        }

        .detail-btn:hover {
            background-color: #138496;
        }

        .prescription-btn {
            background-color: #28a745;
            color: white;
        }

        .prescription-btn:hover {
            background-color: #1e7e34;
        }

        .approved-btn {
            background-color: #28a745;
            color: white;
        }

        .approved-btn:hover {
            background-color: #1e7e34;
        }

        .disapproved-btn {
            background-color: #dc3545;
            color: white;
        }

        .disapproved-btn:hover {
            background-color: #c82333;
        }

        .vet-info {
            margin:25pc 0 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background-color: #f7f7f7;
            border-radius: 8px;
        }

        .vet-details {
            gap: 3px;
            display: flex;
            flex-direction: column;
        }

        .vet-name {
            color: #1f2937;
            font-weight: bold;
            font-size: 14px;
        }

        .vet-role {
            font-size: 12px;
            color: #777;
        }

        .home-btn {
            color: #28a745;
            font-size: 18px;
            text-decoration: none;
        }

        .home-btn:hover {
            color: #1e7e34;
        }

        .logout-btn {
            color: #dc3545;
            font-size: 18px;
            text-decoration: none;
        }

        .logout-btn:hover {
            color: #c82333;
        }

        /* C√°c item trong menu */
        .dropdown-menu .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            text-decoration: none;
            background-color: white;
            color: #333;
            font-size: 14px;
            width: 100%;
            border: none;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
        }

        /* Hover hi·ªáu ·ª©ng */
        .dropdown-menu .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.confirm-btn {
            color: #3dba3a;
            font-weight: 500;
        }

        .dropdown-item.confirm-btn:hover {
            background-color: #ffe5e5;
        }

        .dropdown-item.reject-btn {
            color: #dc3545;
            font-weight: 500;
        }

        .dropdown-item.reject-btn:hover {
            background-color: #ffe5e5;
        }
        /* Dropdown styles */
        .action-dropdown {
            position: relative;
            display: inline-block;
        }

        /* Dropdown ƒë∆°n gi·∫£n */
        .simple-dropdown {
            position: relative;
            display: inline-block;
        }

        .dots-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 8px;
            color: #666;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: visible;
        }

        .action-dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .dropdown-item:hover {
            background-color: #f1f1f1;
        }

        /* Style cho c√°c n√∫t ƒë·∫∑c bi·ªát */
        .approved-btn {
            color: #28a745;
        }

        .disapproved-btn {
            color: #dc3545;
        }

        .prescription-btn {
            color: #17a2b8;
        }

        /* ƒê·∫£m b·∫£o c√°c form kh√¥ng c√≥ margin */
        .action-dropdown form {
            margin: 0;
        }
        /* Modal Header */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 15px;
        }

        /* Action Buttons in Table */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #000;
        }

        .delete-btn {
            background-color: #dc3545;
            color: #fff;
        }

        /* Make table cells editable */
        .editable {
            background-color: #fff8e1;
        }
        /* Modal ch·ªâ xem */
        #viewPrescriptionModal .modal-box {
            max-width: 700px;
        }

        #viewPrescriptionModal .product-table td {
            background-color: #f8f9fa;
            cursor: default;
        }

        #viewPrescriptionModal .product-table tr:hover td {
            background-color: #e9ecef;
        }

        /* ƒê·∫£m b·∫£o modal hi·ªÉn th·ªã tr√™n c√πng v√† c√°c element kh√°c kh√¥ng th·ªÉ t∆∞∆°ng t√°c */
        .modal-overlay.show {
            display: flex !important;
        }

        /* Khi modal hi·ªÉn th·ªã, ·∫©n t·∫•t c·∫£ dropdown */
        .modal-overlay.show ~ .action-dropdown .dropdown-menu {
            display: none !important;
        }

        /* ƒê·∫£m b·∫£o modal content lu√¥n hi·ªÉn th·ªã tr√™n c√πng */
        .modal-content {
            position: relative;
            z-index: 1000001;
        }

        /* Khi modal hi·ªÉn th·ªã, kh√¥ng cho ph√©p scroll body */
        body.modal-open {
            overflow: hidden;
        }

        /* ƒê·∫£m b·∫£o modal lu√¥n hi·ªÉn th·ªã tr√™n c√πng */
        .modal-overlay.show {
            z-index: 999999 !important;
        }

        .modal-overlay.show .modal-box {
            z-index: 1000000 !important;
        }
    </style>
</head>
<body>
<div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2 class="sidebar-title">Doctor Dashboard</h2>
        <ul class="sidebar-menu">
            <li><a th:href="@{/vet/appointment/pending}">‚è≥ L·ªãch kh√°m ch·ªù duy·ªát</a></li>
            <li><a th:href="@{/vet/appointment/approved}">‚úÖ L·ªãch kh√°m ƒë√£ duy·ªát</a></li>
            <li><a th:href="@{/vet/appointment/completed}">üè• L·ªãch kh√°m ƒë√£ ho√†n th√†nh</a></li>
            <li><a th:href="@{/vet/appointment/history}">‚ùå L·ªãch kh√°m t·ª´ ch·ªëi</a></li>
            <li th:if="${mode == 'pending'}"><a href="/staff/work-schedule?from=/vet/appointment/pending">üìÖ Ca l√†m vi·ªác</a></li>
            <li th:if="${mode == 'approved'}"><a href="/staff/work-schedule?from=/vet/appointment/approved">üìÖ Ca l√†m vi·ªác</a></li>
            <li th:if="${mode == 'completed'}"><a href="/staff/work-schedule?from=/vet/appointment/completed">üìÖ Ca l√†m vi·ªác</a></li>
            <li th:if="${mode == 'history'}"><a href="/staff/work-schedule?from=/vet/appointment/history">üìÖ Ca l√†m vi·ªác</a></li>
            <li><a href="/staff/list-pet-profile?from=/vet/appointment/pending">üêæ H·ªì S∆° Th√∫ C∆∞ng</a></li>
        </ul>

        <!-- Th√¥ng tin ng∆∞·ªùi d√πng -->
        <div class="vet-info">
            <div class="vet-details">
                <span class="vet-name" th:text="${session.loggedInUser.getName()}">Name</span>
                <span class="vet-role" th:text="${session.loggedInUser.getRole()}">Role</span>
            </div>
            <div class="vet-details">
                <a href="/home" class="home-btn" title="Home">
                    <i class="fas fa-home"></i>
                </a>
                <a href="/logout" class="logout-btn" title="ƒêƒÉng xu·∫•t">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <h1 class="page-title" th:if="${mode == 'pending'}">L·ªãch kh√°m ch·ªù duy·ªát</h1>
        <h1 class="page-title" th:if="${mode == 'approved'}">L·ªãch kh√°m ƒë√£ duy·ªát</h1>
        <h1 class="page-title" th:if="${mode == 'completed'}">L·ªãch kh√°m ƒë√£ ho√†n t√≠ch</h1>
        <h1 class="page-title" th:if="${mode == 'history'}">L·ªãch kh√°m t·ª´ ch·ªëi</h1>
        <div class="content">
            <!-- Table Container -->
            <div class="table-container">
                <table class="product-table">
                    <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n th√∫ c∆∞ng</th>
                        <th>Th·ªùi ƒëi·ªÉm</th>
                        <th>Th·ªùi gian</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="appointment, stat : ${appointments}">
                        <td th:text="${currentPage * size + stat.index + 1}"></td>
                        <td th:text="${appointment.petProfile.name}"></td>
                        <td th:text="${appointment.bookDate}"></td>
                        <td th:text="${appointment.service != null ? appointment.service.duration : 'N/A'}"> ph√∫t</td>
                        <td th:text="${appointment.status.getValue()}"></td>
                        <!--n√∫t thao t√°c-->
                        <td>
                            <div class="action-dropdown">
                                <button class="dots-toggle">...</button>
                                <div class="dropdown-menu">
                                    <!-- N√∫t Xem chi ti·∫øt -->
                                    <button type="button" class="dropdown-item"
                                            th:data-id="${appointment.appointmentBookingId}"
                                            th:data-date="${appointment.bookDate}"
                                            th:data-status="${appointment.status.getValue()}"
                                            th:data-service="${appointment.service.name}"
                                            th:data-pet-image="${appointment.petProfile.medias.get(0).url}"
                                            th:data-pet-name="${appointment.petProfile.name}"
                                            th:data-pet-species="${appointment.petProfile.species}"
                                            th:data-pet-breeds="${appointment.petProfile.breeds}"
                                            th:data-pet-weight="${appointment.petProfile.weight}"
                                            th:data-pet-age="${appointment.petProfile.age}"
                                            th:data-account-name="${appointment.petProfile.profile.account.name}"
                                            th:data-account-phone="${appointment.petProfile.profile.account.phone}"
                                            th:data-pet-note="${appointment.note}"
                                            onclick="openBookingDetail(this)">
                                        Xem chi ti·∫øt
                                    </button>

                                    <!-- N√∫t ƒê∆°n thu·ªëc m√†n approved-->
                                    <a class="dropdown-item prescription-btn"
                                       th:if="${(mode == 'approved')}"
                                       href="javascript:void(0)"
                                       th:onclick="'openPrescriptionListModal(' + ${appointment.appointmentBookingId} + ')'">
                                        ƒê∆°n thu·ªëc
                                    </a>

                                    <!-- N√∫t ƒê∆°n thu·ªëc m√†n complete-->
                                    <a class="dropdown-item prescription-btn"
                                       th:if="${(mode == 'completed')}"
                                       href="javascript:void(0)"
                                       th:onclick="'openCompletePrescriptionListModal(' + ${appointment.appointmentBookingId} + ')'">
                                        ƒê∆°n thu·ªëc
                                    </a>

                                    <!-- N√∫t Ch·∫•p nh·∫≠n -->
                                    <form th:if="${mode == 'pending'}"
                                          th:action="@{/vet/appointment/approve/{id}(id=${appointment.appointmentBookingId})}"
                                          method="post"
                                          onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ch·∫•p nh·∫≠n cu·ªôc h·∫πn n√†y kh√¥ng?')">
                                        <button type="submit" class="dropdown-item approved-btn">Ch·∫•p nh·∫≠n</button>
                                    </form>

                                    <!-- N√∫t Kh√¥ng ch·∫•p nh·∫≠n -->
                                    <form th:if="${mode == 'pending'}"
                                          th:action="@{/vet/appointment/disapprove/{id}(id=${appointment.appointmentBookingId})}"
                                          method="post"
                                          onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª´ ch·ªëi cu·ªôc h·∫πn n√†y kh√¥ng?')">
                                        <button type="submit" class="dropdown-item disapproved-btn">Kh√¥ng ch·∫•p nh·∫≠n</button>
                                    </form>

                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(appointments)}">
                        <td colspan="6">Kh√¥ng c√≥ cu·ªôc h·∫πn n√†o.</td>
                    </tr>
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="pagination">
                    <ul>
                        <li th:if="${currentPage > 0}">
                            <a th:href="@{/vet/appointment/approved(page=${currentPage - 1}, size=${size})}">&laquo;</a>
                        </li>

                        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a th:href="@{/vet/appointment/approved(page=${i}, size=${size})}" th:text="${i + 1}"></a>
                        </li>

                        <li th:if="${currentPage < totalPages - 1}">
                            <a th:href="@{/vet/appointment/approved(page=${currentPage + 1}, size=${size})}">&raquo;</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
</div>
<!-- Modal Booking Detail -->
<div class="modal-overlay" id="bookingDetailModal" tabindex="-1" aria-labelledby="bookingDetailModalLabel" aria-hidden="true">
    <div class="modal-box">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Chi ti·∫øt</h5>
            </div>
            <div class="booking-info">
                <p><strong>Booking ID:</strong> <span id="popup-id"></span></p>
                <p><strong>Ng√†y ƒë·∫∑t:</strong> <span id="popup-date"></span></p>
                <p><strong>Tr·∫°ng th√°i:</strong> <span id="popup-status"></span></p>
                <p><strong>D·ªãch v·ª•:</strong> <span id="popup-service"></span></p>
                <hr>
                <div class="pet-image">
                    <img id="popup-image" src="" alt="Pet Image">
                </div>
                <div class="pet-info">
                    <p><strong>T√™n th√∫ c∆∞ng:</strong> <span id="popup-petName"></span></p>
                    <p><strong>Lo√†i:</strong> <span id="popup-species"></span></p>
                    <p><strong>Gi·ªëng:</strong> <span id="popup-breed"></span></p>
                    <p><strong>C√¢n n·∫∑ng:</strong> <span id="popup-weight"></span> kg</p>
                    <p><strong>Tu·ªïi:</strong> <span id="popup-age"></span> th√°ng</p>
                </div>
                <hr>
                <div class="owner-info">
                    <p><strong>Ch·ªß nu√¥i:</strong> <span id="popup-owner"></span></p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="popup-phone"></span></p>
                    <p><strong>Ghi ch√∫:</strong> <span id="popup-note"></span></p>
                </div>
            </div>
            <button type="button" class="close-button" onclick="closeDetailPopup()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Modal Prescription List -->
<div id="prescriptionListModal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <div class="modal-header">
            <h2>ƒê∆°n thu·ªëc</h2>
            <button type="button" class="btn btn-primary" onclick="openAddPrescriptionModal()">
                Th√™m thu·ªëc
            </button>
        </div>
        <div class="modal-content">
            <table class="product-table" id="modalPrescriptionListTable">
                <thead>
                <tr>
                    <th>T√™n thu·ªëc</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>C√°ch d√πng</th>
                    <th>Thao t√°c</th>
                </tr>
                </thead>
                <tbody id="modalPrescriptionListBody">
                <!-- JS will populate rows here -->
                </tbody>
            </table>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="completeAppointment()">Ho√†n th√†nh</button>
            <button type="button" class="btn btn-secondary" onclick="closePrescriptionListModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Modal Add/Edit Prescription -->
<div id="prescriptionFormModal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="prescriptionFormTitle">Th√™m thu·ªëc m·ªõi</h2>
        </div>
        <form id="prescriptionForm" onsubmit="handlePrescriptionSubmit(event)">
            <input type="hidden" id="prescriptionId" name="prescriptionId">
            <input type="hidden" id="appointmentId" name="appointmentId">
            <input type="hidden" id="currentContext" name="currentContext" value="">

            <div class="form-group">
                <label for="drugName">T√™n thu·ªëc:</label>
                <input type="text" id="drugName" name="drugName" required maxlength="50">
            </div>

            <div class="form-group">
                <label for="amount">S·ªë l∆∞·ª£ng:</label>
                <input type="number" id="amount" name="amount" required min="1" max="100">
            </div>

            <div class="form-group">
                <label for="note">C√°ch d√πng:</label>
                <textarea id="note" name="note" rows="3" required maxlength="50"></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closePrescriptionFormModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal View Prescription (ch·ªâ xem) -->
<div id="viewPrescriptionModal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <div class="modal-header">
            <h2>ƒê∆°n thu·ªëc ƒë√£ ho√†n th√†nh</h2>
        </div>
        <div class="modal-content">
            <table class="product-table">
                <thead>
                <tr>
                    <th>T√™n thu·ªëc</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>C√°ch d√πng</th>
                </tr>
                </thead>
                <tbody id="viewPrescriptionListBody">
                <!-- JS s·∫Ω ƒëi·ªÅn d·ªØ li·ªáu v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeViewPrescriptionModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>
<!-- Toast Notification -->
<div id="toast" class="toast hidden">
    <span id="toastMessage"></span>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Convert Java objects to JavaScript format
    let prescriptions = /*[[${prescriptions}]]*/ [];
</script>

<!-- Script -->
<script>
    async function openCompletePrescriptionListModal(appointmentId) {
        try {
            currentAppointmentId = appointmentId;
            const modal = document.getElementById('viewPrescriptionModal');
            const tbody = document.getElementById('viewPrescriptionListBody');

            // Hi·ªÉn th·ªã loading
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">ƒêang t·∫£i ƒë∆°n thu·ªëc...</td></tr>';

            // G·ªçi API ƒë·ªÉ l·∫•y ƒë∆°n thu·ªëc
            const response = await fetch(`/vet/appointment/prescriptions?appointmentId=${appointmentId}`);

            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu ƒë∆°n thu·ªëc');
            }

            const data = await response.json();
            prescriptions = data;

            // Hi·ªÉn th·ªã d·ªØ li·ªáu
            tbody.innerHTML = '';

            if (prescriptions.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center">Kh√¥ng c√≥ ƒë∆°n thu·ªëc</td>
                </tr>
            `;
            } else {
                prescriptions.forEach(prescription => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${prescription.drugName || 'N/A'}</td>
                    <td>${prescription.amount || 'N/A'}</td>
                    <td>${prescription.note || 'N/A'}</td>
                `;
                    tbody.appendChild(tr);
                });
            }

            modal.style.display = 'flex';
        } catch (error) {
            console.error("Error loading prescriptions:", error);
            const tbody = document.getElementById('viewPrescriptionListBody');
            tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center error">L·ªói khi t·∫£i ƒë∆°n thu·ªëc: ${error.message}</td>
            </tr>
        `;
        }
    }

    function closeViewPrescriptionModal() {
        const modal = document.getElementById('viewPrescriptionModal');
        modal.style.display = 'none';
        modal.classList.remove("show");
        document.body.classList.remove("modal-open");
    }
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        toastMessage.innerText = message;
        toast.className = `toast show ${type}`;
        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.classList.add('hidden'), 300);
        }, 3000);
    }

    function openBookingDetail(button) {
        document.getElementById("popup-id").textContent = button.getAttribute("data-id");
        document.getElementById("popup-date").textContent = formatDateTime(button.getAttribute("data-date"));
        document.getElementById("popup-status").textContent = button.getAttribute("data-status");
        document.getElementById("popup-service").textContent = button.getAttribute("data-service");

        document.getElementById("popup-image").src = button.getAttribute("data-pet-image");
        document.getElementById("popup-petName").textContent = button.getAttribute("data-pet-name");
        document.getElementById("popup-species").textContent = button.getAttribute("data-pet-species");
        document.getElementById("popup-breed").textContent = button.getAttribute("data-pet-breeds");
        document.getElementById("popup-weight").textContent = button.getAttribute("data-pet-weight");
        document.getElementById("popup-age").textContent = button.getAttribute("data-pet-age");

        document.getElementById("popup-owner").textContent = button.getAttribute("data-account-name");
        document.getElementById("popup-phone").textContent = button.getAttribute("data-account-phone");
        document.getElementById("popup-note").textContent = button.getAttribute("data-pet-note");

        // Hi·ªÉn th·ªã modal
        const modal = document.getElementById("bookingDetailModal");
        modal.style.display = "flex";
        modal.classList.add("show");
        document.body.classList.add("modal-open");

        // ·∫®n t·∫•t c·∫£ dropdown khi modal hi·ªÉn th·ªã
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }

    function formatDateTime(datetimeStr) {
        if (!datetimeStr) return "Kh√¥ng c√≥";
        const date = new Date(datetimeStr);
        if (isNaN(date.getTime())) return datetimeStr;
        return date.toLocaleString("vi-VN", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });
    }

    function closeDetailPopup() {
        const modal = document.getElementById('bookingDetailModal');
        modal.style.display = 'none';
        modal.classList.remove("show");
        document.body.classList.remove("modal-open");
    }

    let currentAppointmentId = null;

    function openPrescriptionListModal(appointmentId) {
        currentAppointmentId = appointmentId;

        const modal = document.getElementById('prescriptionListModal');
        const tbody = document.getElementById('modalPrescriptionListBody');

        // Clear previous rows
        tbody.innerHTML = '';

        // Filter prescriptions for this appointment
        const filteredPrescriptions = prescriptions.filter(p =>
            p.appointmentId == appointmentId ||
            p.appointment?.appointmentBookingId == appointmentId
        );

        // Populate table
        filteredPrescriptions.forEach(pre => {
            const tr = document.createElement('tr');
            tr.dataset.prescriptionId = pre.prescriptionId;
            renderPrescriptionRow(tr, pre);
            tbody.appendChild(tr);
        });

        // Load l·∫°i danh s√°ch thu·ªëc
        refreshPrescriptionList();

        // Show modal
        modal.style.display = 'flex';
        modal.classList.add("show");
        document.body.classList.add("modal-open");

        // ·∫®n t·∫•t c·∫£ dropdown khi modal hi·ªÉn th·ªã
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }

    async function refreshPrescriptionList() {
        if (!currentAppointmentId) return;

        try {
            const response = await fetch(`/vet/appointment/prescriptions?appointmentId=${currentAppointmentId}`);
            if (response.ok) {
                const data = await response.json();
                prescriptions = data;
                renderPrescriptionList();
            }
        } catch (error) {
            console.error("Error refreshing prescription list:", error);
        }
    }

    function openAddPrescriptionModal() {
        const formModal = document.getElementById('prescriptionFormModal');
        const formTitle = document.getElementById('prescriptionFormTitle');
        const form = document.getElementById('prescriptionForm');

        formTitle.textContent = 'Th√™m thu·ªëc m·ªõi';
        form.reset();
        document.getElementById('appointmentId').value = currentAppointmentId;
        document.getElementById('prescriptionId').value = '';

        formModal.style.display = 'flex';
        formModal.classList.add("show");
        document.body.classList.add("modal-open");

        // ·∫®n t·∫•t c·∫£ dropdown khi modal hi·ªÉn th·ªã
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }


    function closePrescriptionFormModal() {
        const modal = document.getElementById('prescriptionFormModal');
        modal.style.display = 'none';
        modal.classList.remove("show");
        document.body.classList.remove("modal-open");
    }

    /**
     * Render danh s√°ch ƒë∆°n thu·ªëc v√†o b·∫£ng
     */
    function renderPrescriptionList() {
        const tbody = document.getElementById('modalPrescriptionListBody');
        if (!tbody) {
            console.error('Kh√¥ng t√¨m th·∫•y tbody ƒë·ªÉ render danh s√°ch thu·ªëc');
            return;
        }

        tbody.innerHTML = '';

        // L·ªçc ƒë∆°n thu·ªëc theo appointmentId hi·ªán t·∫°i
        const filteredPrescriptions = prescriptions.filter(p =>
            p.appointmentId == currentAppointmentId ||
            p.appointment?.appointmentBookingId == currentAppointmentId
        );

        if (filteredPrescriptions.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center">Ch∆∞a c√≥ thu·ªëc n√†o ƒë∆∞·ª£c k√™</td>
            </tr>
        `;
            return;
        }

        // Render t·ª´ng d√≤ng
        filteredPrescriptions.forEach(prescription => {
            const tr = document.createElement('tr');
            tr.dataset.prescriptionId = prescription.prescriptionId;

            tr.innerHTML = `
            <td class="editable" contenteditable="false"
                data-maxlength="50"
                oninput="validateDrugName(this)">
                ${prescription.drugName || prescription.prescriptionDrugName}
            </td>
            <td class="editable" contenteditable="false"
                data-min="1"
                data-max="100"
                oninput="validateAmount(this)">
                ${prescription.amount || prescription.prescriptionAmount}
            </td>
            <td class="editable" contenteditable="false"
                data-maxlength="50"
                oninput="validateNote(this)">
                ${prescription.note || prescription.prescriptionNote}
            </td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="toggleEditPrescription(this)">
                    S·ª≠a
                </button>
                <button class="delete-btn"
                        onclick="deletePrescription(${prescription.prescriptionId})">
                    X√≥a
                </button>
            </td>
        `;
            tbody.appendChild(tr);
        });
    }

    // C√°c h√†m validate
    function validateDrugName(element) {
        const maxLength = parseInt(element.getAttribute('data-maxlength')) || 50;
        const content = element.textContent.trim();

        // Ki·ªÉm tra kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng
        if (content === '') {
            element.textContent = ''; // X√≥a n·∫øu ch·ªâ c√≥ kho·∫£ng tr·∫Øng
            showToast('T√™n thu·ªëc kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
            return false; // Tr·∫£ v·ªÅ false n·∫øu kh√¥ng h·ª£p l·ªá
        }

        // Ki·ªÉm tra ƒë·ªô d√†i t·ªëi ƒëa
        if (content.length > maxLength) {
            element.textContent = content.substring(0, maxLength);
            showToast(`T√™n thu·ªëc t·ªëi ƒëa ${maxLength} k√Ω t·ª±`, 'warning');
            return false;
        }

        return true; // Tr·∫£ v·ªÅ true n·∫øu h·ª£p l·ªá
    }

    function validateAmount(element) {
        const min = parseInt(element.getAttribute('data-min')) || 1;
        const max = parseInt(element.getAttribute('data-max')) || 100;

        // Ch·ªâ cho ph√©p nh·∫≠p s·ªë
        element.textContent = element.textContent.replace(/[^0-9]/g, '');

        const value = parseInt(element.textContent) || 0;

        if (value < min) {
            element.textContent = min;
            showToast(`S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu l√† ${min}`, 'warning');
            return false;
        } else if (value > max) {
            element.textContent = max;
            showToast(`S·ªë l∆∞·ª£ng t·ªëi ƒëa l√† ${max}`, 'warning');
            return false;
        }

        return true;
    }

    function validateNote(element) {
        const maxLength = parseInt(element.getAttribute('data-maxlength')) || 50;
        const content = element.textContent.trim();

        // Ki·ªÉm tra kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng
        if (content === '') {
            element.textContent = '';
            showToast('Ghi ch√∫ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
            return false;
        }

        // Ki·ªÉm tra ƒë·ªô d√†i t·ªëi ƒëa
        if (content.length > maxLength) {
            element.textContent = content.substring(0, maxLength);
            showToast(`Ghi ch√∫ t·ªëi ƒëa ${maxLength} k√Ω t·ª±`, 'warning');
            return false;
        }

        return true;
    }

    function toggleEditPrescription(button) {
        const row = button.closest('tr');
        const isEditing = row.querySelector('.editable').isContentEditable;

        if (isEditing) {
            // L·∫•y c√°c √¥ c·∫ßn validate
            const drugNameCell = row.cells[0];
            const amountCell = row.cells[1];
            const noteCell = row.cells[2];

            // Th·ª±c hi·ªán validate t·∫•t c·∫£ c√°c tr∆∞·ªùng
            const isDrugNameValid = validateDrugName(drugNameCell);
            const isAmountValid = validateAmount(amountCell);
            const isNoteValid = validateNote(noteCell);

            // N·∫øu b·∫•t k·ª≥ tr∆∞·ªùng n√†o kh√¥ng h·ª£p l·ªá th√¨ kh√¥ng l∆∞u
            if (!isDrugNameValid || !isAmountValid || !isNoteValid) {
                return;
            }

            // Ti·∫øp t·ª•c x·ª≠ l√Ω l∆∞u d·ªØ li·ªáu n·∫øu t·∫•t c·∫£ ƒë·ªÅu h·ª£p l·ªá
            const prescriptionId = row.dataset.prescriptionId;
            const prescriptionIndex = prescriptions.findIndex(p => p.prescriptionId == prescriptionId);

            if (prescriptionIndex !== -1) {
                const updatedData = {
                    prescriptionId: prescriptionId,
                    drugName: drugNameCell.textContent.trim(),
                    amount: parseInt(amountCell.textContent),
                    note: noteCell.textContent.trim(),
                    appointmentId: currentAppointmentId
                };

                updatePrescription(updatedData)
                    .then(updatedPrescription => {
                        prescriptions[prescriptionIndex] = updatedPrescription;
                        row.querySelectorAll('.editable').forEach(cell => {
                            cell.contentEditable = false;
                            cell.classList.remove('editing');
                        });
                        button.textContent = 'S·ª≠a';
                        showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
                    })
                    .catch(error => {
                        console.error("Update error:", error);
                        showToast("L·ªói khi c·∫≠p nh·∫≠t: " + error.message, "error");
                    });
            }
        } else {
            // B·∫≠t ch·∫ø ƒë·ªô edit
            row.querySelectorAll('.editable').forEach(cell => {
                cell.contentEditable = true;
                cell.classList.add('editing');
            });
            button.textContent = 'L∆∞u';
        }
    }

    function renderPrescriptionRow(row, prescription) {
        row.innerHTML = `
        <td class="editable" contenteditable="false">${prescription.drugName || prescription.prescriptionDrugName}</td>
        <td class="editable" contenteditable="false">${prescription.amount || prescription.prescriptionAmount}</td>
        <td class="editable" contenteditable="false">${prescription.note || prescription.prescriptionNote}</td>
        <td class="action-buttons">
            <button class="edit-btn" onclick="toggleEditPrescription(this)">S·ª≠a</button>
            <button class="delete-btn" onclick="deletePrescription(${prescription.prescriptionId})">X√≥a</button>
        </td>
    `;
    }

    async function handlePrescriptionSubmit(event) {
        event.preventDefault();

        // L∆∞u appointmentId hi·ªán t·∫°i v√†o sessionStorage
        sessionStorage.setItem('lastEditedAppointmentId', currentAppointmentId);

        const form = event.target;
        const formData = {
            appointmentId: currentAppointmentId, // S·ª≠ d·ª•ng bi·∫øn ƒë√£ l∆∞u khi m·ªü modal
            drugName: form.drugName.value,
            amount: form.amount.value,
            note: form.note.value
        };

        try {
            const response = await fetch('/vet/appointment/prescriptions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create prescription');
            }

            const result = await response.json();
            showToast("Th√™m thu·ªëc th√†nh c√¥ng!", "success");
            closePrescriptionFormModal();
            openPrescriptionListModal(currentAppointmentId); // Refresh danh s√°ch

            // Sau khi t·∫°o th√†nh c√¥ng, reload trang
            window.location.reload();
        } catch (error) {
            console.error("Error creating prescription:", error);
            showToast(error.message || "C√≥ l·ªói x·∫£y ra khi th√™m thu·ªëc!", "error");
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Ki·ªÉm tra n·∫øu c√≥ appointmentId trong sessionStorage
        const lastEditedAppointmentId = sessionStorage.getItem('lastEditedAppointmentId');

        if (lastEditedAppointmentId) {
            // M·ªü modal prescription list
            openPrescriptionListModal(lastEditedAppointmentId);

            // X√≥a d·ªØ li·ªáu ƒë√£ l∆∞u
            sessionStorage.removeItem('lastEditedAppointmentId');
        }

        // Kh·ªüi t·∫°o d·ªØ li·ªáu ban ƒë·∫ßu
        initializeData(prescriptions);
    });
    function initializeData(initialPrescriptions) {
        // Ki·ªÉm tra n·∫øu c√≥ d·ªØ li·ªáu t·ª´ Thymeleaf
        if (typeof initialPrescriptions !== 'undefined') {
            prescriptions = Array.isArray(initialPrescriptions) ? initialPrescriptions : [];
        } else {
            // Ho·∫∑c kh·ªüi t·∫°o m·∫£ng r·ªóng n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
            prescriptions = [];
        }

        console.log('Initialized prescriptions:', prescriptions);

        // Ki·ªÉm tra n·∫øu c·∫ßn m·ªü modal sau khi reload
        const lastAppointmentId = sessionStorage.getItem('lastEditedAppointmentId');
        if (lastAppointmentId) {
            openPrescriptionListModal(lastAppointmentId);
            sessionStorage.removeItem('lastEditedAppointmentId');
        }
    }

    async function updatePrescription(prescriptionData) {
        try {
            const response = await fetch(`/vet/appointment/prescriptions/${prescriptionData.prescriptionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(prescriptionData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update prescription');
            }

            return await response.json();
        } catch (error) {
            console.error("Update error:", error);
            throw error;
        }
    }

    async function deletePrescription(prescriptionId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thu·ªëc n√†y kh√¥ng?')) {
            return;
        }

        try {
            const response = await fetch(`/vet/appointment/prescriptions/${prescriptionId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete prescription');
            }

            // Remove from local array
            const index = prescriptions.findIndex(p => p.prescriptionId == prescriptionId);
            if (index !== -1) {
                prescriptions.splice(index, 1);
            }

            showToast("X√≥a thu·ªëc th√†nh c√¥ng!", "success");
            // Refresh the prescription list
            openPrescriptionListModal(currentAppointmentId);
        } catch (error) {
            console.error("Error deleting prescription:", error);
            showToast("C√≥ l·ªói x·∫£y ra khi x√≥a thu·ªëc!", "error");
        }
    }

    function closePrescriptionListModal() {
        const modal = document.getElementById('prescriptionListModal');
        modal.style.display = 'none';
        modal.classList.remove("show");
        document.body.classList.remove("modal-open");
        currentAppointmentId = null;
    }

    async function completeAppointment() {
        if (!currentAppointmentId) {
            showToast("Kh√¥ng t√¨m th·∫•y ID cu·ªôc h·∫πn", "error");
            return;
        }

        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n th√†nh cu·ªôc h·∫πn n√†y kh√¥ng?')) {
            return;
        }

        try {
            const response = await fetch(`/vet/appointment/complete/${currentAppointmentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to complete appointment');
            }

            showToast("ƒê√£ ho√†n th√†nh cu·ªôc h·∫πn th√†nh c√¥ng!", "success");
            closePrescriptionListModal();
            // Reload page to update status
            window.location.reload();
        } catch (error) {
            console.error("Error completing appointment:", error);
            showToast(error.message || "C√≥ l·ªói x·∫£y ra khi ho√†n th√†nh cu·ªôc h·∫πn!", "error");
        }
    }

    // Add active class to current menu item
    document.addEventListener('DOMContentLoaded', function() {
        const menuItems = document.querySelectorAll('.sidebar-menu li');

        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                menuItems.forEach(li => li.classList.remove('active'));
                // Add active class to clicked item
                this.classList.add('active');
            });
        });

        // ƒê√≥ng dropdown khi click ra ngo√†i (ƒë·ªÉ tr√°nh dropdown b·ªã m·∫Øc k·∫πt)
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.action-dropdown')) {
                // Kh√¥ng c·∫ßn l√†m g√¨ v√¨ dropdown s·∫Ω t·ª± ƒë·ªông ƒë√≥ng khi kh√¥ng hover
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const dropdowns = document.querySelectorAll('.action-dropdown');

        dropdowns.forEach(dropdown => {
            let timeout;
            const menu = dropdown.querySelector('.dropdown-menu');

            // M·ªü dropdown khi hover v√†o n√∫t ho·∫∑c menu
            const showMenu = () => {
                clearTimeout(timeout);
                menu.style.display = 'block';
                menu.style.opacity = '1';
                menu.style.transform = 'translateY(0)';
                menu.style.pointerEvents = 'auto';
                menu.style.zIndex = '100001';
                dropdown.style.zIndex = '100000';
            };

            // ƒê√≥ng dropdown v·ªõi delay
            const hideMenu = () => {
                timeout = setTimeout(() => {
                    menu.style.opacity = '0';
                    menu.style.transform = 'translateY(-5px)';
                    menu.style.pointerEvents = 'none';
                    menu.style.zIndex = '100001';
                    dropdown.style.zIndex = '10000';
                    setTimeout(() => {
                        menu.style.display = 'none';
                    },);
                },);
            };

            // S·ª± ki·ªán cho n√∫t dropdown
            dropdown.addEventListener('mouseenter', showMenu);
            dropdown.addEventListener('mouseleave', hideMenu);

            // S·ª± ki·ªán cho menu
            menu.addEventListener('mouseenter', showMenu);
            menu.addEventListener('mouseleave', hideMenu);
        });
    });
</script>
</body>
</html>