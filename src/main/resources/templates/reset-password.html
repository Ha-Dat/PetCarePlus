<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</title>
    <link rel="stylesheet" th:href="@{css/header.css}">
    <style>
        .password-wrapper {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
        }
        .bg {
            background: url("https://i.ibb.co/q3p27MRN/507038009-1245302843643877-8250570055874749465-n.png") no-repeat center center;
            background-size: cover;
            font-family: sans-serif;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin-top: -10px;
        }

        .form-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0px 5px 15px rgba(0,0,0,0.2);
            width: 350px;
            text-align: center;
        }

        .form-box input {
            width: 92%;
            margin: 10px 0;
            padding: 10px;
        }

        .form-box button {
            background-color: #8dbd5c;
            border: none;
            padding: 10px;
            width: 100%;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }

        .form-box .link {
            display: block;
            margin-top: 10px;
            font-size: 14px;
            color: #8dbd5c;
            text-decoration: none;
        }
        
        .error-message {
            color: red;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .success-message {
            color: green;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .step.active {
            background: #8dbd5c;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }

        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 11px;
            line-height: 1.4;
            text-align: left;
        }
        
        .form-group small strong {
            color: #333;
            font-weight: 600;
        }
        
        .password-strength {
            margin-top: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Footer Styling */
        footer {
            background-color: #e8f5e9;
            padding: 30px 40px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            font-size: 14px;
            color: #333;
            border-top: 2px solid #c8e6c9;
        }

        footer section {
            margin-bottom: 20px;
            min-width: 200px;
        }

        footer h4 {
            margin-bottom: 12px;
            font-size: 16px;
            color: #1b5e20;
        }

        footer ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        footer a {
            color: #333;
            text-decoration: none;
            display: block;
            padding: 4px 0;
            transition: color 0.2s ease;
        }

        footer a:hover {
            color: #2e7d32;
        }
    </style>
</head>
<body>
<div th:insert="component/header :: header"></div>
<div class="bg">
    <div class="login-container">
        <div class="form-box">
            <h2>ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h2>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- Step 1: Enter Information -->
            <div id="step1Content" class="step-content active">
                <form id="resetPasswordForm">
                    <div class="form-group">
                        <label for="username">H·ªç t√™n ƒëƒÉng k√Ω</label>
                        <input type="text" id="username" name="username" 
                               placeholder="Nh·∫≠p h·ªç t√™n ƒë√£ ƒëƒÉng k√Ω" required>
                        <small>H·ªç t√™n ph·∫£i tr√πng v·ªõi th√¥ng tin ƒëƒÉng k√Ω t√†i kho·∫£n</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="phoneNumber">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" 
                               placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                    </div>

                    <button type="button" onclick="validateInfo()">X√°c th·ª±c th√¥ng tin</button>
                </form>
            </div>

            <!-- Step 2: New Password -->
            <div id="step2Content" class="step-content">
                <form id="newPasswordForm">
                    <div class="form-group">
                        <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                        <div class="password-wrapper">
                            <input type="password" id="newPassword" name="newPassword" 
                                   placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" required>
                            <span class="toggle-password" onclick="togglePassword('newPassword')">üëÅ</span>
                        </div>
                        <small>
                            <strong>Y√™u c·∫ßu m·∫≠t kh·∫©u:</strong><br>
                            ‚Ä¢ √çt nh·∫•t 8 k√Ω t·ª±, t·ªëi ƒëa 50 k√Ω t·ª±<br>
                            ‚Ä¢ Ph·∫£i c√≥ ch·ªØ hoa (A-Z)<br>
                            ‚Ä¢ Ph·∫£i c√≥ ch·ªØ th∆∞·ªùng (a-z)<br>
                            ‚Ä¢ Ph·∫£i c√≥ s·ªë (0-9)<br>
                            ‚Ä¢ Kh√¥ng ch·ª©a kho·∫£ng tr·∫Øng
                        </small>
                        <div id="passwordStrength" class="password-strength"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirmPassword" name="confirmPassword" 
                                   placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
                            <span class="toggle-password" onclick="togglePassword('confirmPassword')">üëÅ</span>
                        </div>
                    </div>

                    <button type="button" onclick="resetPassword()">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
                </form>
            </div>

            <a th:href="@{/login}" class="link">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
        </div>
    </div>
</div>
<div th:insert="component/footer :: footer"></div>

<script>
    let currentStep = 1;
    let phoneNumber = '';
    let username = '';

    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const alertClass = type === 'success' ? 'success-message' : 'error-message';
        alertContainer.innerHTML = `<div class="${alertClass}">${message}</div>`;
    }

    function updateStepIndicator() {
        // Reset all steps
        document.querySelectorAll('.step').forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index + 1 < currentStep) {
                step.classList.add('completed');
            } else if (index + 1 === currentStep) {
                step.classList.add('active');
            }
        });
    }

    function showStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });

        // Show current step
        if (stepNumber === 1) {
            document.getElementById('step1Content').classList.add('active');
        } else if (stepNumber === 2) {
            document.getElementById('step2Content').classList.add('active');
        }

        currentStep = stepNumber;
        updateStepIndicator();
    }

    async function validateInfo() {
        username = document.getElementById('username').value.trim();
        phoneNumber = document.getElementById('phoneNumber').value.trim();

        if (!username || !phoneNumber) {
            showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† s·ªë ƒëi·ªán tho·∫°i', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/reset-password/validate-info?username=${username}&phoneNumber=${phoneNumber}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                showAlert(`‚úÖ X√°c th·ª±c th√†nh c√¥ng! H·ªç t√™n "${username}" v√† s·ªë ƒëi·ªán tho·∫°i "${phoneNumber}" h·ª£p l·ªá. Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi.`);
                showStep(2);
            } else {
                showAlert(result.message || 'Th√¥ng tin kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i h·ªç t√™n v√† s·ªë ƒëi·ªán tho·∫°i.', 'error');
            }
        } catch (error) {
            showAlert('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
        }
    }

    async function resetPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!newPassword || !confirmPassword) {
            showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m·∫≠t kh·∫©u', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            showAlert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
            return;
        }

        if (newPassword.length < 8) {
            showAlert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±', 'error');
            return;
        }
        
        if (newPassword.length > 50) {
            showAlert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t h∆°n 50 k√Ω t·ª±', 'error');
            return;
        }
        
        // Ki·ªÉm tra pattern m·∫≠t kh·∫©u
        const passwordPattern = /^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=\S+$).{8,50}$/;
        if (!passwordPattern.test(newPassword)) {
            showAlert('M·∫≠t kh·∫©u ph·∫£i g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë v√† kh√¥ng ch·ª©a kho·∫£ng tr·∫Øng', 'error');
            return;
        }

        try {
            const response = await fetch('/api/reset-password/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    phoneNumber: phoneNumber,
                    newPassword: newPassword,
                    confirmPassword: confirmPassword
                })
            });

            const result = await response.json();

                    if (result.success) {
            showAlert('ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p...');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói t·ª´ backend
            let errorMessage = result.message || 'Kh√¥ng th·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u';
            
            // N·∫øu c√≥ validation error t·ª´ backend, hi·ªÉn th·ªã chi ti·∫øt
            if (result.fieldErrors) {
                errorMessage = Object.values(result.fieldErrors).join(', ');
            }
            
            showAlert(errorMessage, 'error');
        }
        } catch (error) {
            showAlert('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
        }
    }

    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
            input.type = "text";
        } else {
            input.type = "password";
        }
    }
    
    // Ki·ªÉm tra ƒë·ªô m·∫°nh m·∫≠t kh·∫©u real-time
    function checkPasswordStrength(password) {
        const checks = {
            length: password.length >= 8 && password.length <= 50,
            lowercase: /[a-z]/.test(password),
            uppercase: /[A-Z]/.test(password),
            number: /[0-9]/.test(password),
            noWhitespace: !/\s/.test(password)
        };
        
        return checks;
    }
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë·ªô m·∫°nh m·∫≠t kh·∫©u
    function updatePasswordStrength() {
        const password = document.getElementById('newPassword').value;
        const checks = checkPasswordStrength(password);
        
        // T·∫°o th√¥ng b√°o v·ªÅ ƒë·ªô m·∫°nh m·∫≠t kh·∫©u
        let strengthMessage = '';
        let strengthClass = 'error-message';
        
        if (password.length === 0) {
            strengthMessage = '';
        } else if (Object.values(checks).every(check => check)) {
            strengthMessage = '‚úÖ M·∫≠t kh·∫©u ƒë·∫°t y√™u c·∫ßu';
            strengthClass = 'success-message';
        } else {
            strengthMessage = '‚ùå M·∫≠t kh·∫©u ch∆∞a ƒë·∫°t y√™u c·∫ßu';
            strengthClass = 'error-message';
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o ƒë·ªô m·∫°nh
        const strengthElement = document.getElementById('passwordStrength');
        if (strengthElement) {
            strengthElement.innerHTML = strengthMessage;
            strengthElement.className = strengthClass;
        }
    }

    // Initialize
    updateStepIndicator();
    
    // Th√™m event listener cho input m·∫≠t kh·∫©u
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('newPassword');
        if (passwordInput) {
            passwordInput.addEventListener('input', updatePasswordStrength);
        }
    });
</script>
</body>
</html>
