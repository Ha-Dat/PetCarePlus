<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Checkout - PetCare+</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;700&family=Marcellus&display=swap"
          rel="stylesheet">
</head>

<body>
<!--&lt;!&ndash; Header &ndash;&gt;-->
<!--<div th:replace="~{fragments/header :: header}"></div>-->

<section class="checkout-section py-5">
    <div class="container">
        <form th:action="@{/checkout/create}" method="post">
            <div class="row g-4">
                <!-- Billing & Shipping Information -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title mb-4">Thông tin giao hàng</h4>
                            <div id="formErrorAlert" class="alert alert-danger d-none" role="alert"></div>

                            <!-- Địa chỉ mặc định -->
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Họ tên</label>
                                <input type="text" id="fullName" class="form-control" th:value="${profile.account.name}"
                                       readonly>
                            </div>
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Số điện thoại</label>
                                <input type="text" id="phoneNumber" class="form-control"
                                       th:value="${profile.account.phone}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Địa chỉ mặc định</label>
                                <textarea class="form-control"
                                          th:text="${profile.ward.name + ', ' + profile.district.name + ', ' + profile.city.name}"
                                          readonly>
                                </textarea>
                            </div>
                            <!-- Số nhà, tên đường cho địa chỉ mặc định -->
                            <div class="mb-3" id="defaultAddressDetailWrapper">
                                <label for="defaultAddressDetail" class="form-label">Số nhà, tên đường</label>
                                <input type="text" id="defaultAddressDetail" name="address"
                                       class="form-control" placeholder="VD: 123 Lê Lợi">
                            </div>
                            <!-- Checkbox giao đến địa chỉ khác -->
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="differentAddress"
                                       name="differentAddress">
                                <label class="form-check-label" for="differentAddress">
                                    Giao đến địa chỉ khác
                                </label>
                            </div>

                            <!-- Form nhập địa chỉ khác (ẩn mặc định) -->
                            <div id="differentAddressFields" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Tên người nhận</label>
                                    <input type="text" class="form-control" name="receiverName">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" name="receiverPhone">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Số nhà, tên đường</label>
                                    <input type="text" class="form-control" name="address">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phường/Xã</label>
                                    <input type="text" class="form-control" name="ward">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Quận/Huyện</label>
                                    <input type="text" class="form-control" name="district">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tỉnh/Thành phố</label>
                                    <input type="text" class="form-control" name="city">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Method -->
                    <div class="card shadow-sm mt-4">
                        <div class="card-body">
                            <h4 class="card-title mb-4">Phương thức vận chuyển</h4>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="shippingMethod"
                                       id="expressShipping" value="EXPRESS" checked>
                                <label class="form-check-label" for="expressShipping">
                                    <strong>Giao hàng nhanh (Hỏa tốc)</strong>
                                    <p class="text-muted small mb-0">Giao trong 1-2 ngày làm việc</p>
                                </label>
                                <span class="float-end fw-bold" id="expressFee">...</span>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="shippingMethod"
                                       id="standardShipping" value="STANDARD">
                                <label class="form-check-label" for="standardShipping">
                                    <strong>Giao hàng tiêu chuẩn</strong>
                                    <p class="text-muted small mb-0">Giao trong 3-5 ngày làm việc</p>
                                </label>
                                <span class="float-end fw-bold" id="standardFee">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title mb-4">Đơn hàng của bạn</h4>

                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th class="text-end">Tổng</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="entry : ${cartItems}">
                                        <td>
                                            <span th:text="${entry.key.name}"></span> ×
                                            <span th:text="${entry.value}"></span>
                                        </td>
                                        <td class="text-end">
                                            <span th:text="${#numbers.formatCurrency(entry.key.price.doubleValue() * entry.value) + ' VND'}"></span>
                                        </td>
                                    </tr>
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <th>Tạm tính</th>
                                        <td class="text-end" id="subtotal"
                                            th:text="${#numbers.formatCurrency(subtotal.doubleValue()) + 'VND'}"></td>
                                    </tr>
                                    <tr id="discountRow" style="display: none;">
                                        <th>Giảm giá</th>
                                        <td class="text-end text-success" id="discountAmount">-0đ</td>
                                    </tr>
                                    <tr class="fw-bold">
                                        <th>Tổng cộng</th>
                                        <td class="text-end" id="totalPrice"
                                            th:text="${#numbers.formatCurrency(subtotal.doubleValue()) + 'VND'}"></td>
                                        <input type="hidden" name="totalPrice" th:value="${subtotal}"/>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Coupon Code -->
                            <div class="mb-4">
                                <label class="form-label">Mã giảm giá (nếu có)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="couponCode"
                                           placeholder="Nhập mã giảm giá">
                                    <button class="btn btn-outline-secondary" type="button" id="applyCoupon">Áp dụng
                                    </button>
                                </div>
                                <div id="couponMessage" class="small mt-2"></div>
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-4">
                                <h5 class="mb-3">Phương thức thanh toán</h5>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="codPayment" value="COD" checked>
                                    <label class="form-check-label" for="codPayment">
                                        Thanh toán khi nhận hàng (COD)
                                    </label>
                                </div>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="vnpayPayment" value="VNPAY">
                                    <label class="form-check-label" for="vnpayPayment">
                                        Thanh toán qua VNPay
                                    </label>
                                </div>

                            </div>

                            <!-- Terms and Place Order -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    Tôi đồng ý với <a href="#">điều khoản và điều kiện</a> của PetCare+
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 py-3" id="placeOrderBtn">
                                ĐẶT HÀNG
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Footer -->
<!--<div th:replace="~{fragments/footer :: footer}"></div>-->

<!-- Scripts -->
<script>
    $(document).ready(function () {
        // Toggle địa chỉ khác
        $('#differentAddress').change(function () {
            if (this.checked) {
                $('#differentAddressFields').show();
                $('#defaultAddressDetailWrapper').hide();
            } else {
                $('#differentAddressFields').hide();
                $('#defaultAddressDetailWrapper').show();
            }
        });

        // Validate form trước khi submit
        $('form').on('submit', function (e) {
            let isValid = true;
            let errors = [];

            if ($('#differentAddress').is(':checked')) {
                // Validate tên người nhận
                const receiverName = $('input[name="receiverName"]').val().trim();
                if (receiverName.length < 2) {
                    isValid = false;
                    errors.push("Tên người nhận phải có ít nhất 2 ký tự.");
                }

                // Validate số điện thoại
                const receiverPhone = $('input[name="receiverPhone"]').val().trim();
                const phonePattern = /^(0|\+84)(\d{9})$/;
                if (!phonePattern.test(receiverPhone)) {
                    isValid = false;
                    errors.push("Số điện thoại không hợp lệ (VD: 0912345678).");
                }

                // Validate địa chỉ
                const deliveryAddress = $('input[name="deliveryAddress"]').val().trim();
                if (deliveryAddress.length < 3) {
                    isValid = false;
                    errors.push("Vui lòng nhập số nhà, tên đường hợp lệ.");
                }

                // Validate ward, district, city
                const ward = $('input[name="ward"]').val().trim();
                const district = $('input[name="district"]').val().trim();
                const city = $('input[name="city"]').val().trim();
                if (!ward || !district || !city) {
                    isValid = false;
                    errors.push("Vui lòng nhập đầy đủ phường/xã, quận/huyện và tỉnh/thành phố.");
                }

            } else {
                // Validate địa chỉ mặc định
                const defaultAddressDetail = $('#defaultAddressDetail').val().trim();
                if (defaultAddressDetail.length < 3) {
                    isValid = false;
                    errors.push("Vui lòng nhập số nhà, tên đường hợp lệ cho địa chỉ mặc định.");
                }
            }

            if (!$('#agreeTerms').is(':checked')) {
                isValid = false;
                errors.push("Bạn phải đồng ý với điều khoản và điều kiện.");
            }

            if (!isValid) {
                e.preventDefault();

                // Hiển thị lỗi trong alert
                $('#formErrorAlert')
                    .removeClass('d-none')
                    .html("<strong>Lỗi:</strong><br>" + errors.join("<br>"));

                // Cuộn lên đầu form để thấy thông báo
                $('html, body').animate({ scrollTop: $('#formErrorAlert').offset().top - 20 }, 300);
            } else {
                $('#formErrorAlert').addClass('d-none').html('');
            }
        });
    });
</script>
</body>
</html>