<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Checkout - PetCare+</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;700&family=Marcellus&display=swap"
          rel="stylesheet">
</head>

<body>
<!--&lt;!&ndash; Header &ndash;&gt;-->
<!--<div th:replace="~{fragments/header :: header}"></div>-->

<section class="checkout-section py-5">
    <div class="container">
        <form th:action="@{/checkout/create}" method="post">
            <div class="row g-4">
                <!-- Billing & Shipping Information -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title mb-4">Thông tin giao hàng</h4>
                            <div id="formErrorAlert" class="alert alert-danger d-none" role="alert"></div>

                            <!-- Địa chỉ mặc định -->
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Họ tên</label>
                                <input type="text" id="fullName" class="form-control" th:value="${profile.account.name}"
                                       readonly>
                            </div>
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Số điện thoại</label>
                                <input type="text" id="phoneNumber" class="form-control"
                                       th:value="${profile.account.phone}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Địa chỉ mặc định</label>
                                <textarea class="form-control"
                                          th:text="${profile.ward.name + ', ' + profile.city.name}"
                                          readonly>
                                </textarea>
                            </div>
                            <!-- Số nhà, tên đường cho địa chỉ mặc định -->
                            <div class="mb-3" id="defaultAddressDetailWrapper">
                                <label for="defaultAddressDetail" class="form-label">Số nhà, tên đường</label>
                                <input type="text" id="defaultAddressDetail" name="address"
                                       class="form-control" placeholder="VD: 123 Lê Lợi">
                            </div>
                            <!-- Checkbox giao đến địa chỉ khác -->
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="differentAddress"
                                       name="differentAddress">
                                <label class="form-check-label" for="differentAddress">
                                    Giao đến địa chỉ khác
                                </label>
                            </div>

                            <!-- Form nhập địa chỉ khác (ẩn mặc định) -->
                            <div id="differentAddressFields" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Tên người nhận</label>
                                    <input type="text" class="form-control" name="receiverName">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" name="receiverPhone">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Số nhà, tên đường</label>
                                    <input type="text" class="form-control" name="address">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phường/Xã</label>
                                    <input type="text" class="form-control" name="ward">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tỉnh/Thành phố</label>
                                    <input type="text" class="form-control" name="city">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4"></div>
                    <a href="/view-cart" class="btn btn-secondary w-50 py-3">
                        Trở lại giỏ hàng
                    </a>
                </div>


                <!-- Order Summary -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title mb-4">Đơn hàng của bạn</h4>

                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th class="text-end">Tổng</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="entry : ${cartItems}">
                                        <td>
                                            <span th:text="${entry.key.name}"></span> ×
                                            <span th:text="${entry.value}"></span>
                                        </td>
                                        <td class="text-end">
                                            <span th:text="${#numbers.formatDecimal(entry.key.price.doubleValue() * entry.value, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span>
                                        </td>
                                    </tr>
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <th>Tạm tính</th>
                                        <td class="text-end" id="subtotal"
                                            th:attr="data-value=${subtotal}"
                                            th:text="${#numbers.formatDecimal(subtotal.doubleValue(), 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                                    </tr>
                                    <tr id="discountRow" style="display: none;">
                                        <th>Giảm giá</th>
                                        <td class="text-end text-success" id="discountAmount">-0đ</td>
                                    </tr>
                                    <tr class="fw-bold">
                                        <th>Tổng cộng</th>
                                        <td class="text-end" id="totalPrice"
                                            th:text="${#numbers.formatDecimal(subtotal.doubleValue(), 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                                        <input type="hidden" name="totalPrice" th:value="${subtotal}"/>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Coupon Code -->
                            <div class="mb-4">
                                <label class="form-label">Mã giảm giá (nếu có)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="couponCode"
                                           placeholder="Nhập mã giảm giá">
                                    <button class="btn btn-outline-secondary" type="button" id="applyCoupon">Áp dụng
                                    </button>
                                </div>
                                <div id="couponMessage" class="small mt-2"></div>
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-4">
                                <h5 class="mb-3">Phương thức thanh toán</h5>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="codPayment" value="COD" checked>
                                    <label class="form-check-label" for="codPayment">
                                        Thanh toán khi nhận hàng (COD)
                                    </label>
                                </div>

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="vnpayPayment" value="VNPAY">
                                    <label class="form-check-label" for="vnpayPayment">
                                        Thanh toán qua VNPay
                                    </label>
                                </div>

                            </div>

                            <!-- Terms and Place Order -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    Tôi đồng ý với <a href="#">điều khoản và điều kiện</a> của PetCare+
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 py-3" id="placeOrderBtn">
                                ĐẶT HÀNG
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>
</section>

<!-- Footer -->
<!--<div th:replace="~{fragments/footer :: footer}"></div>-->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Toggle địa chỉ khác
        $('#differentAddress').change(function () {
            if (this.checked) {
                $('#differentAddressFields').show();
                $('#defaultAddressDetailWrapper').hide();
            } else {
                $('#differentAddressFields').hide();
                $('#defaultAddressDetailWrapper').show();
            }
        });

        // Validate form trước khi submit
        $('form').on('submit', function (e) {
            let isValid = true;
            let errors = [];

            if ($('#differentAddress').is(':checked')) {
                // Validate tên người nhận
                const receiverName = $('input[name="receiverName"]').val().trim();
                if (receiverName.length < 2) {
                    isValid = false;
                    errors.push("Tên người nhận phải có ít nhất 2 ký tự.");
                }

                // Validate số điện thoại
                const receiverPhone = $('input[name="receiverPhone"]').val().trim();
                const phonePattern = /^(0|\+84)(\d{9})$/;
                if (!phonePattern.test(receiverPhone)) {
                    isValid = false;
                    errors.push("Số điện thoại không hợp lệ (VD: 0912345678).");
                }

                // Validate địa chỉ
                const deliveryAddress = $('input[name="deliveryAddress"]').val().trim();
                if (deliveryAddress.length < 3) {
                    isValid = false;
                    errors.push("Vui lòng nhập số nhà, tên đường hợp lệ.");
                }

                // Validate ward, city
                const ward = $('input[name="ward"]').val().trim();
                const city = $('input[name="city"]').val().trim();
                if (!ward || !city) {
                    isValid = false;
                    errors.push("Vui lòng nhập đầy đủ phường/xã, quận/huyện và tỉnh/thành phố.");
                }

            } else {
                // Validate địa chỉ mặc định
                const defaultAddressDetail = $('#defaultAddressDetail').val().trim();
                if (defaultAddressDetail.length < 3) {
                    isValid = false;
                    errors.push("Vui lòng nhập số nhà, tên đường hợp lệ cho địa chỉ mặc định.");
                }
            }

            if (!$('#agreeTerms').is(':checked')) {
                isValid = false;
                errors.push("Bạn phải đồng ý với điều khoản và điều kiện.");
            }

            if (!isValid) {
                e.preventDefault();

                // Hiển thị lỗi trong alert
                $('#formErrorAlert')
                    .removeClass('d-none')
                    .html("<strong>Lỗi:</strong><br>" + errors.join("<br>"));

                // Cuộn lên đầu form để thấy thông báo
                $('html, body').animate({ scrollTop: $('#formErrorAlert').offset().top - 20 }, 300);
            } else {
                $('#formErrorAlert').addClass('d-none').html('');
            }
        });
    });

    // Coupon
    $(document).ready(function () {
        // Sự kiện áp dụng coupon
        $('#applyCoupon').click(function () {
            let couponCode = $('#couponCode').val();

            // Trim khoảng trắng 2 đầu
            let trimmed = couponCode.trim();

            // Kiểm tra rỗng hoặc toàn khoảng trắng
            if (trimmed.length === 0) {
                $('#couponMessage').text("Vui lòng nhập mã giảm giá.").css('color', 'red');
                return;
            }

            // Kiểm tra chứa khoảng trắng bên trong
            if (/\s/.test(trimmed)) {
                $('#couponMessage').text("Mã giảm giá không được chứa khoảng trắng.").css('color', 'red');
                return;
            }

            // Nếu hợp lệ, gọi API
            $.ajax({
                url: '/checkout/apply-coupon',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    couponCode: trimmed,
                    subtotal: parseFloat($('#subtotal').attr('data-value'))
                }),
                success: function (res) {
                    if (res.valid) {
                        $('#discountRow').show();
                        $('#discountAmount').text('-' + res.discountFormatted);
                        $('#totalPrice').text(res.totalFormatted);
                        $('input[name="totalPrice"]').val(res.total);
                        $('input[name="discountAmount"]').remove();
                        $('<input>').attr({
                            type: 'hidden',
                            name: 'discountAmount',
                            value: res.discount
                        }).appendTo('form');
                        $('<input>').attr({
                            type: 'hidden',
                            name: 'couponCode',
                            value: trimmed
                        }).appendTo('form');
                        $('#couponMessage').text("Áp dụng mã giảm giá thành công!").css('color', 'green');
                    } else {
                        $('#couponMessage').text(res.message).css('color', 'red');
                    }
                },
                error: function () {
                    $('#couponMessage').text("Có lỗi xảy ra khi áp dụng mã.").css('color', 'red');
                }
            });
        });
    });
</script>
</body>
</html>